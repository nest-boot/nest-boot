---
title: "Request Context"
description: "Share request-scoped state across your NestJS application with AsyncLocalStorage-based context propagation."
---

The `@nest-boot/request-context` module provides a request-scoped storage layer built on Node.js `AsyncLocalStorage`. It allows you to share state — such as the authenticated user, session, workspace, or entity manager — across all services and resolvers within a single request, without threading it through function arguments.

## Installation

```bash
pnpm add @nest-boot/request-context
```

## Module Registration

```typescript
import { RequestContextModule } from "@nest-boot/request-context";

@Global()
@Module({
  imports: [RequestContextModule],
})
export class CommonModule {}
```

## Basic Usage

### Setting Values

Store values from middleware, guards, or any service:

```typescript
import { RequestContext } from "@nest-boot/request-context";
import { User } from "./user.entity";
import { Workspace } from "./workspace.entity";

// In a middleware or guard
RequestContext.set(User, authenticatedUser);
RequestContext.set(Workspace, currentWorkspace);
```

### Getting Values

Retrieve values anywhere in the request lifecycle:

```typescript
import { RequestContext } from "@nest-boot/request-context";
import { User } from "./user.entity";

const user = RequestContext.get(User);
```

### Request Object

Access the Express request via the `REQUEST` token:

```typescript
import { REQUEST, RequestContext } from "@nest-boot/request-context";
import { Request } from "express";

const request = RequestContext.get<Request>(REQUEST);
const workspaceId = request?.headers["x-workspace-id"];
```

## Common Patterns

### Auth + Workspace Context

A typical pattern in multi-tenant applications:

```typescript
// In AuthModule configuration
onAuthenticated: async () => {
  const user = RequestContext.get(User);
  const request = RequestContext.get<Request>(REQUEST);
  const workspaceId = request?.headers["x-workspace-id"];

  if (user && typeof workspaceId === "string") {
    const workspaceMember = await em.findOne(
      WorkspaceMember,
      { user, workspace: { id: workspaceId } },
      { populate: ["workspace"] },
    );

    if (workspaceMember) {
      RequestContext.set(Workspace, workspaceMember.workspace.getEntity());
      RequestContext.set(WorkspaceMember, workspaceMember);
    }
  }
},
```

### Using in Services

```typescript
import { RequestContext } from "@nest-boot/request-context";
import { Injectable } from "@nestjs/common";

@Injectable()
export class AuditService {
  getCurrentUser(): User | undefined {
    return RequestContext.get(User);
  }

  getCurrentWorkspace(): Workspace | undefined {
    return RequestContext.get(Workspace);
  }
}
```

## Middleware Registration

The module supports registering custom middleware within the request context:

```typescript
RequestContext.registerMiddleware("my-middleware", (ctx, next) => {
  ctx.set(SomeService, someInstance);
  return next();
});
```

This is used internally by modules like `MikroOrmModule` to fork the entity manager per request.

## Best Practices

1. **Use Class Keys** — Use entity/service classes as keys (e.g., `User`, `Workspace`) for type-safe lookups.

2. **Set Early** — Populate the context in middleware or the `onAuthenticated` callback, not in resolvers or services.

3. **Read-Only in Services** — Services should only read from `RequestContext`, never write.

## API Reference

For detailed API documentation, see the [Request Context API Reference](/docs/api/request-context).
